name: Update Statistics

on:
  workflow_dispatch: # run manually from actions tab
  schedule:
  - cron: 0 0 * * 1 # run once a week at monday midnight

permissions: {} # Set permissions at the job level.

jobs:

  update-statistics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - name: Generate the user stats image
      # Ref: https://github.com/cicirello/user-statistician?tab=readme-ov-file#inputs
      uses: cicirello/user-statistician@24d5642dfb851e6072721d73031629de20c84fb3 # v1.23.0
      with:
        image-file: images/statistics.svg
        commit-message: "chore: update user statistics\n\nAutomatically generated by cicirello/user-statistician [skip ci]"
        include-title: false
        featured-repository: oaipmh-scythe
        hide-keys: private mostStarred mostForked
      env:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

  update-metrics:
    needs: update-statistics # both jobs might add a new commit to the main branch, so we need to run them on after the other
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      # Ref: https://github.com/lowlighter/metrics/blob/master/action.yml
      - uses: lowlighter/metrics@65836723097537a54cd8eb90f61839426b4266b6 # v3.34
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          filename: images/metrics.svg
          committer_message: "chore: update github-metrics\n\nAutomatically generated by lowlighter/metrics [skip ci]"
          config_timezone: Europe/Berlin
          base_hireable: false
          base: header, activity, community, repositories, metadata
          plugin_languages: true
          user: afuetterer
          # Ref: https://github.com/lowlighter/metrics/blob/master/source/plugins/core/README.md#advanced-pattern-matching
          repositories_skipped: |
            @use.patterns
            -afuetterer/*
            +afuetterer/oaipmh-scythe
